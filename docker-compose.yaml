version: "3.8"

services:
  kong:
    build:
      context: .
      dockerfile: Dockerfile.kong
    restart: always
    container_name: kong-gateway
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yaml
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: info
      KONG_NGINX_WORKER_PROCESSES: auto
      # Timeouts globales (en milisegundos)
      KONG_NGINX_PROXY_CONNECT_TIMEOUT: "60000"
      KONG_NGINX_PROXY_SEND_TIMEOUT: "60000"
      KONG_NGINX_PROXY_READ_TIMEOUT: "60000"
      # Keepalive para mejor rendimiento
      KONG_NGINX_HTTP_KEEPALIVE_REQUESTS: "100"
      KONG_NGINX_HTTP_KEEPALIVE_TIMEOUT: "60"
      INTERNAL_SECRET: ${INTERNAL_SECRET}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "8000:8000"  # Proxy
      - "8001:8001"  # Admin API (opcional, para debugging)
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - kong-network

networks:
  kong-network:
    driver: bridge